\RequirePackage{mfirstuc} %To capitalize just the inicial letter of each word. There is a command to exclude specific words to captalize such like a, an, the, etc.

\RequirePackage{tcolorbox}
	\tcbuselibrary{theorems, listings, breakable, most, skins}
	\tcbsetforeverylayer{shield externalize}


% Creates the banner of task environment
\newcommand{\la@contentsepbanner}[1]{
	\leavevmode\checkoddpage%
	\begin{tikzpicture}[remember picture, overlay, shift = {(0,-13.5pt)}]

		\draw [\currentcolor,  line width = 3pt] (-\la@studentleftmargin,0) -- (\la@studenttextwidth+\la@studentrightmargin,0);
		\node (banner name) [
			fill, \currentcolor, rectangle, rounded corners=10, anchor = east, minimum width = 3.5cm, minimum height = 20pt] 
			at (\la@studenttextwidth,0) {{\bannernamefont \la@banner@name}};
		\node [anchor = west] (banner title) at (0,-1.5em) {{\boxtitlefont #1}};

	\end{tikzpicture}
}


% Creates the box with section colors for examples and observations
\newtcolorbox{la@sectionbox}[2]{
	parbox = false, 
	blanker, enhanced, breakable, 
	before skip = 5mm, after skip = 5mm, 
	left = 3mm, right = 3mm, top = 1em, bottom = 3mm, 
	leftrule = -.05pt, rightrule = -.05pt, toprule = 2pt, bottomrule = -.05pt, 
	colframe = \currentcolor, colback = boxbackground, 
	title = #1, fonttitle = \boxtitlefont\vphantom{Ag},
	attach boxed title to top left = {%
		% xshift = 3mm
	},
	boxed title style = {colback = white, colframe = white,},
	underlay boxed title = {%
		\coordinate (fne) at (frame.north east);

		% \filldraw [draw = white, fill = white] (title.south west) rectangle (title.north east);

		\filldraw [draw = \currentcolor, fill = \currentcolor]
		($(fne) + (-.2pt,0)$) -- ++ (0,18pt) -- ++ (-6pc,0)
			.. controls +(-1.5pc,-1pt) and ($(fne) + (-10.5pc,-1pt)$) ..
			($(fne) + (-12pc, -1pt)$) -- (fne) -- cycle;
			
		\node [anchor = south east, font = \boxnamefont\vphantom{Ag}] at (frame.north east) {#2};
	}
}


% Creates the box with current volume color and icon
\newtcolorbox{la@volumebox}[1]{
	parbox = false, 
	blanker, enhanced, breakable, 
	before skip = 5mm, after skip = 5mm, 
	left = 3mm, right = 3mm, top = 1em, bottom = 3mm, 
	leftrule = -.05pt, rightrule = -.05pt, toprule = 2pt, bottomrule = -.05pt, 
	colframe = \currentvolcolor, colback = boxbackground, 
	title = #1, fonttitle = \boxnamefont\vphantom{Ag},
	boxed title style = {%
		empty, arc = 0pt, outer arc = 0pt, boxrule = 0pt
	},
	attach boxed title to top left = {%
		% xshift = 3mm
	},
	underlay boxed title = {%
		 \coordinate (tsw) at (title.south west);
		 \coordinate (tnw) at (title.north west);
		 
		 \filldraw [draw = \currentvolcolor, fill = \currentvolcolor]
			  ($(tnw) + (.0pt,0)$) -- ++ (6pc,0)
			  .. controls +(1.5pc, 0pt) and ($(tsw) + (10.5pc,0)$) ..
			  ($(tsw) + (12pc,-1pt)$) -- ($(tsw) + (.2pt,-1pt)$) -- cycle;
		 \node [overlay, left of = tnw, node distance = 18pt, yshift = -12pt] {\includegraphics[width=22pt]{\la@boxicon-\currentvolcolor.pdf}};
	}
}


% Environments

\newcounter{task}[chapter]

\newenvironment{task}[1]{\par
	\refstepcounter{task}
	\la@bannername{Atividade \thetask}
	\la@contentsepbanner{#1}
	\vspace{3em}
}{}


\newcounter{example}[chapter]

\newenvironment{example}[1]{
	\refstepcounter{example}
	\begin{la@sectionbox}{#1}{Exemplo \theexample}
}{
	\end{la@sectionbox}
}


\newenvironment{observation}[1]{
	\refstepcounter{example}
	\begin{la@sectionbox}{#1}{Exemplo \theexample}
}{
	\end{la@sectionbox}
}


\newenvironment{reflection}{
	\def\la@boxicon{refletir}
	\begin{la@volumebox}{Para refletir}
}{
	\end{la@volumebox}
}


\newenvironment{knowledge}{
	\def\la@boxicon{vcsabia}
	\begin{la@volumebox}{VocÃª Sabia?}
}{
	\end{la@volumebox}
}


\newenvironment{research}{
	\def\la@boxicon{notas}
	\begin{la@volumebox}{Notas}
}{
	\end{la@volumebox}
}



\NewEnviron{project}{%
	\setlist[itemize]{label = \protect\itemcoloredsquare}
	\def\currentcolor{cor2}
	\newpage
	\tikzset{external/export next = false}
	\begin{tikzpicture}[remember picture, overlay, external/export = false]
		\coordinate (border1) at ($(current page text area.south east) + (0.00mm,8.00mm)$);
		\coordinate (border1a) at ($(border1) + (-5.00mm,2.00mm)$);
		\coordinate (border1b) at ($(current page text area.south west) + (11.00mm,10.00mm)$);
		\coordinate (border1c) at ($(current page text area.north west) + (11.00mm,-13.00mm)$);
		\coordinate (border1d) at ($(current page text area.south west) + (11.00mm,13.00mm)$);
		\coordinate (heading) at ($(current page text area.north west) + (32.50mm,-5.00mm)$);
		\coordinate (corner1) at ($(current page text area.north west) + (6.00mm,-10.00mm)$);
		\coordinate (corner2) at ($(current page text area.north east) + (-4.00mm,-10.00mm)$);
		\coordinate (corner3) at ($(current page text area.south east) + (0.00mm,10.00mm)$);
		\coordinate (corner4) at ($(current page text area.south west) + (10.00mm,6.00mm)$);
		\coordinate (text1) at ($(current page text area.north west) + (11.00,-12.50mm)$);
		\coordinate (text2) at ($(current page text area.south east) + (-2.50mm,8.50mm)$);
		\coordinate (bodytextpos) at ($(border1c) + (5.00mm,-3.00mm)$);

		\begin{pgfonlayer}{background}
			\draw [draw = base1, fill = base1] (current page text area.south west) rectangle (current page text area.north east);
		\end{pgfonlayer}

		\begin{pgfonlayer}{main}
			\draw [fill = cor2, draw = cor2] (current page text area.north west) -- ++(0.00mm,-8.00mm) arc [start angle = 180, end angle = 270, x radius = 2.00mm, y radius = 2.00mm] -| ++(63.00mm,8.00mm) arc [start angle = 0, end angle = 90, x radius = 2.00mm, y radius = 2.00mm] -- cycle;
			\draw [fill = base1!30, draw = base1!30] (corner1) -- (corner2) arc [start angle = 90, end angle = 0, x radius = 4.00mm, y radius = 4.00mm] -- (corner3) arc [start angle = 0, end angle = -90, x radius = 4.00mm, y radius = 4.00mm] -- (corner4) arc [start angle = 270, end angle = 180, x radius = 4.00mm, y radius = 4.00mm] -- cycle;
			% \draw [green] (text1) rectangle (text2);
			\draw [black] (border1a) -- (border1b) -- (border1c) -| cycle;

		\end{pgfonlayer}

		\begin{pgfonlayer}{foreground}
			\node [color = base1!30, font = \titlefont\bfseries\fontsize{13pt}{0}\selectfont] (title) at (heading) {PROJETO APLICADO};
			\node [box, below right] (bodytext) at (border1c){%
				\begin{minipage}{0.85\textwidth}
					\BODY
				\end{minipage}
			};
		\end{pgfonlayer}


	\end{tikzpicture}
	\clearpage
}
