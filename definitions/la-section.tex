\RequirePackage[explicit]{titlesec}

\newlength{\la@bannername@width}
\newlength{\la@bannername@height}
\newlength{\la@bannername@tip}
\newlength{\la@titlebeforeskip}
\newlength{\la@titleafterskip}

\setlength{\la@titlebeforeskip}{1em plus 2pt minus 1pt}
\setlength{\la@titleafterskip}{2em plus 3pt minus 1pt}

\setlength{\la@bannername@width}{130pt}
\setlength{\la@bannername@height}{20pt}
\setlength{\la@bannername@tip}{25pt}

\newcommand{\la@default@banner@length}{
  \setlength{\la@bannername@width}{130pt}
  \setlength{\la@bannername@height}{20pt}
  \setlength{\la@bannername@tip}{25pt}
}

\newcommand{\la@large@banner@length}{
  \setlength{\la@bannername@width}{200pt}
  \setlength{\la@bannername@height}{20pt}
  \setlength{\la@bannername@tip}{25pt}
}
% Defines the banner used for the sections
\newcommand{\la@bannernamestyle}[1][]{
		\coordinate [#1] (tag west) at 
      ($(-1\la@bannername@tip,0pt)$);
		\coordinate (tag east) at 
      ($(tag west) + (\la@bannername@width, 0pt)$);
		\coordinate (tag upper left) at 
      ($(tag west) + (\la@bannername@tip, .5\la@bannername@height)$);
		\coordinate (tag lower left) at 
      ($(tag west) + (\la@bannername@tip, -.5\la@bannername@height)$);
		\coordinate (tag upper right) at 
      ($(tag west) + (\la@bannername@width - \la@bannername@tip, .5\la@bannername@height)$);
		\coordinate (tag lower right) at 
      ($(tag west) + (\la@bannername@width - \la@bannername@tip, -.5\la@bannername@height)$);

		\draw [rounded corners=4, fill = \currentcolor] (tag west) 
                                                 -- (tag upper left) 
                                                 -- (tag upper right) 
                                                 -- (tag east) 
                                                 -- (tag lower right) 
                                                 -- (tag lower left) 
                                                 -- cycle;

		\node (banner name) [font = \vphantom{A}, anchor = center] at 
      ($(tag east)!.5!(tag west)$) {{\bannernamefont \la@bannername}};
}

\newcommand{\la@bannerstyle}[1]{
	\leavevmode\checkoddpage%
  % \la@default@banner@length
  \tikzset{external/export next=false}
	\begin{tikzpicture}[remember picture, overlay]
		\draw [\currentcolor,  line width = 3pt] (-\la@student@leftmargin,0) 
    -- (\la@student@textwidth,0);

		\la@bannernamestyle

		\node (banner title) [
        anchor = east, fill, rectangle, white, inner sep = 2.5pt,
        outer sep = 1pt, font = \vphantom{Ag}
      ]
			at (\la@student@textwidth+.4em,0) {{\hspace*{2.5pt}\bannertitlefont #1}};
	\end{tikzpicture}
}


\newcommand{\la@exercisebanner}{
  \la@default@banner@length
	\tikzset{external/export next=false}
	\begin{tikzpicture}[remember picture, overlay]
		\draw [principal,  line width = 3pt] (-\la@student@leftmargin,0) 
    -- (\la@student@textwidth+\la@student@rightmargin,0);

		\la@bannernamestyle[shift = {(.5\la@student@textwidth-.5\la@bannername@width+\la@bannername@tip,0)}]
	\end{tikzpicture}
}

\newcommand{\la@largebannerstyle}{
  \la@large@banner@length
	\tikzset{external/export next=false}
	\begin{tikzpicture}[remember picture, overlay]
		\draw [principal,  line width = 3pt] (-\la@student@leftmargin,0) 
      -- (\la@student@textwidth+\la@student@rightmargin,0);

		\la@bannernamestyle
	\end{tikzpicture}
}


\titleclass{\la@banner}{straight}[\section]
	\providecommand*{\toclevel@la@banner}{1}
	\titlespacing{\la@banner}{0pt}{\la@titlebeforeskip}{\la@titleafterskip}
	\titleformat{\la@banner}[hang]{\bannertitlefont}{}{0pt}{%
		\needspace{6em}
		\la@bannerstyle{#1}
		\la@defaultlist%
	}	

\titleclass{\la@exercise}{straight}[\chapter]
	\providecommand*{\toclevel@la@exercise}{1}
	\titlespacing{\la@exercise}{0pt}{\la@titlebeforeskip}{\la@titleafterskip}
	\titleformat{\la@exercise}[hang]{\bannertitlefont}{}{0pt}{%
		\needspace{6em}
		\la@exercisebanner		
	}

\titleclass{\la@largebanner}{straight}[\chapter]
	\providecommand*{\toclevel@la@largebanner}{1}
	\titlespacing{\la@largebanner}{0pt}{\la@titlebeforeskip}{\la@titleafterskip}
	\titleformat{\la@largebanner}[hang]{\bannertitlefont}{}{0pt}{%
		\la@largebannerstyle
	}


% Formatação dos comandos \section e \subsection
\renewcommand{\toclevel@section}{1}
\newtoggle{la@section}
\titlespacing*{\section}{0pt}{2mm}{1mm}
\titleformat{\section}{
	\sectiontitlefont
	}{\thesection}{0pt}{%
		\cleardoublepage
		#1
		\toggletrue{la@section}		
	}

\let\la@section\section %chktex 1

\renewcommand{\section}[1]{
	\la@section{#1}
	\iftoggle{teacher}\teachercol@on
	\toggletrue{la@section}
	\thispagestyle{livroaberto}
}

\renewcommand{\toclevel@subsection}{4}
\titlespacing*{\subsection}{0pt}{2mm}{1mm}
\titleformat{\subsection}{
	\color{\currentcolor}\normalfont\Large\bfseries
}{\thesection}{1em}{#1}


\titleformat{\paragraph}{
	\color{\currentcolor}\normalfont\large\bfseries
	}{\thesubsection}{1em}{#1}
		
	\titlespacing*{\paragraph}{0pt}{1mm}{1mm}
	\renewcommand{\toclevel@paragraph}{5}


\newcommand{\bannername}[1]{
	\def\la@bannername{#1}
}

\newcommand{\la@bannercounter}[1]{
	\def\la@banner@counter{#1}
}


\newcommand{\explore}[1]{%
	\par
	\sectioncolor{session1}
	\bannername{Explorando}

	\iftoggle{la@section}{
		\clearpage
		\togglefalse{la@section}
	}{
		\cleardoublepage%	
	}

	\thispagestyle{livroaberto}
	\iftoggle{teacher}\teachercol@on
	\la@banner{%
		\texorpdfstring{}{\la@bannername: }#1
	}
	\la@defaultlist
}

\newcommand{\practice}[1]{%
	\sectioncolor{session2}
	\bannername{Praticando}
	\la@banner{%
		\texorpdfstring{}{\la@bannername: }#1
	}
	\la@defaultlist
}

\newcommand{\know}[1]{%
	\sectioncolor{session3}
	\bannername{Saiba Mais}
	\la@banner{%
		\texorpdfstring{}{\la@bannername: }#1
	}
	\la@defaultlist
}

\newcommand{\arrange}[1]{%
	\sectioncolor{session4}
	\bannername{Organizando}
	\la@bannercounter{\thearrange}
	\la@banner{%
		\texorpdfstring{}{\la@bannername: }#1
	}
	\la@defaultlist
}

\newcommand{\exercise}{	
	\sectioncolor{principal}
	\bannername{\strut{Exercícios}}
	\la@exercise{\texorpdfstring{}{Exercícios}}
	\la@exerciselist%
}

\newcommand{\additionalmaterial}{	
	\sectioncolor{principal}
	\bannername{Material Suplementar}
	\la@largebanner{\texorpdfstring{}{Material Suplementar}}
	\la@defaultlist%
}


% \newcommand{\expandtocdepth}[1][]{%
% 	\renewcommand{\toclevel@section}{1}
% 	\renewcommand{\toclevel@subsection}{4}
% 	\renewcommand{\toclevel@paragraph}{5}
% 	\renewcommand{\toclevel@subparagraph}{6}

% 	\renewcommand{\toclevel@exploresec}{2}
% 	\renewcommand{\toclevel@practicesec}{2}
% 	\renewcommand{\toclevel@arrangesec}{2}
% 	\setcounter{tocdepth}{2}

% 	\IfStrEqCase{#1}{%
% 		{}{
% }%
% 		{know}{
% 			\renewcommand{\toclevel@knowsec}{2}
% 		}%
% 		{exercise}{
% 			\renewcommand{\toclevel@exercisesec}{2}
% 		}%
% 		{know, exercise}{
% 			\renewcommand{\toclevel@knowsec}{2}
% 			\renewcommand{\toclevel@exercisesec}{2}
% 		}
% 	}[%
% 	Apenas os valores ``know'' e ``exercise'' são permitidos.
% 	]%
% }


